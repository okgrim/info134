var toaletter = [
  {
  "herre":"1",
  "tid_sondag":"07.00 - 23.15",
  "pissoir_only":"NULL",
  "stellerom":"NULL",
  "latitude":"60.388076",
  "tid_hverdag":"07.00 - 23.15",
  "plassering":"NONNESETER TERMINAL , SØR",
  "tid_lordag":"07.00 - 23.15",
  "rullestol":"1",
  "adresse":"Lungegårdskaien",
  "pris":"12",
  "id":"1",
  "place":"NONNESETER TERMINAL, SOUTH",
  "dame":"1",
  "longitude":"5.334937"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"NULL",
  "latitude":"60.388871",
  "tid_hverdag":"05.30 - 23.50",
  "plassering":"NONNESETER TERMINAL , NORD",
  "tid_lordag":"07.00 - 23.15",
  "rullestol":"1",
  "adresse":"Østre Strømkai",
  "pris":"12",
  "id":"2",
  "place":"NONNESETER TERMINAL , NORTH",
  "dame":"1",
  "longitude":"5.334079"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"NULL",
  "latitude":"60.388868",
  "tid_hverdag":"09.00 - 17.00",
  "plassering":"SKYSS KUNDESENTER",
  "tid_lordag":"09.00 - 15.00",
  "rullestol":"1",
  "adresse":"Østre Strømkai",
  "pris":"12",
  "id":"3",
  "place":"SKYSS CUSTOMER CENTRE",
  "dame":"1",
  "longitude":"5.334079"
  },
  {
  "herre":"1",
  "tid_sondag":"07.00 - 23.00",
  "pissoir_only":"NULL",
  "stellerom":"NULL",
  "latitude":"60.39041",
  "tid_hverdag":"07.00 - 23.00",
  "plassering":"JERNBANESTASJONEN",
  "tid_lordag":"07.00 - 23.00",
  "rullestol":"NULL",
  "adresse":"Strømgaten 4",
  "pris":"10",
  "id":"4",
  "place":"RAILWAY STATION",
  "dame":"1",
  "longitude":"5.332995"
  },
  {
  "herre":"1",
  "tid_sondag":"08.30 - 22.00",
  "pissoir_only":"NULL",
  "stellerom":"1",
  "latitude":"60.394554",
  "tid_hverdag":"09.00 - 23.00",
  "plassering":"MATHALLEN",
  "tid_lordag":"08.30 - 22.00",
  "rullestol":"1",
  "adresse":"Strandkaien 3",
  "pris":"10",
  "id":"5",
  "place":"FISH MARKET",
  "dame":"1",
  "longitude":"5.324099"
  },
  {
  "herre":"1",
  "tid_sondag":"08.00 - 18.00",
  "pissoir_only":"NULL",
  "stellerom":"",
  "latitude":"60.395432",
  "tid_hverdag":"08.00 - 18.00",
  "plassering":"STRANDKAITERMINALEN",
  "tid_lordag":"08.00 - 18.00",
  "rullestol":"",
  "adresse":"Strandkaien",
  "pris":"10",
  "id":"6",
  "place":"STRANDKAI BOAT TERMINAL",
  "dame":"1",
  "longitude":"5.321034"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"NULL",
  "latitude":"60.3913929",
  "tid_hverdag":"08.00 - 15.00",
  "plassering":"BERGEN KOMMUNE, INNBYGGERSERVICE",
  "tid_lordag":"NULL",
  "rullestol":"1",
  "adresse":"Kaigaten 4",
  "pris":"0",
  "id":"7",
  "place":"CITIZEN SERVICE CENTRE",
  "dame":"1",
  "longitude":"5.326855"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"1",
  "latitude":"60.3891794",
  "tid_hverdag":"09.00 - 21.00",
  "plassering":"BERGEN STORSENTER",
  "tid_lordag":"09.00 - 18.00",
  "rullestol":"1",
  "adresse":"Strømgaten 8",
  "pris":"10",
  "id":"8",
  "place":"BERGEN STORSENTER",
  "dame":"1",
  "longitude":"5.3305793"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"1",
  "latitude":"60.392209",
  "tid_hverdag":"09.00 - 21.00",
  "plassering":"SUNDT MOTEHUS",
  "tid_lordag":"09.00 - 18.00",
  "rullestol":"1",
  "adresse":"Torgallmenningen 14",
  "pris":"10",
  "id":"9",
  "place":"SUNDT FASHION HOUSE",
  "dame":"1",
  "longitude":"5.324011"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"1",
  "latitude":"60.3928444",
  "tid_hverdag":"09.00 - 20.00",
  "plassering":"XHIBITION",
  "tid_lordag":"09.00 - 18.00",
  "rullestol":"1",
  "adresse":"Småstrandgaten 3",
  "pris":"10",
  "id":"10",
  "place":"XHIBITION",
  "dame":"1",
  "longitude":"5.3239541"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"1",
  "latitude":"60.3947371",
  "tid_hverdag":"09.00 - 21.00",
  "plassering":"GALLERIET",
  "tid_lordag":"09.00 - 18.00",
  "rullestol":"1",
  "adresse":"Torgallmenningen 8",
  "pris":"10",
  "id":"11",
  "place":"GALLERIET",
  "dame":"1",
  "longitude":"5.3243561"
  },
  {
  "herre":"1",
  "tid_sondag":"NULL",
  "pissoir_only":"NULL",
  "stellerom":"1",
  "latitude":"60.3944194",
  "tid_hverdag":"10.00 - 20.00",
  "plassering":"KLØVERHUSET",
  "tid_lordag":"10.00 - 18.00",
  "rullestol":"1",
  "adresse":"Strandgaten 13 -15",
  "pris":"10",
  "id":"12",
  "place":"KLØVERHUSET",
  "dame":"1",
  "longitude":"5.3205649"
  },
  {
  "herre":"1",
  "tid_sondag":"09.00 - 18.00",
  "pissoir_only":"NULL",
  "stellerom":"NULL",
  "latitude":"60.3974108",
  "tid_hverdag":"09.00 - 18.00",
  "plassering":"BRYGGEN BESØKSSENTER",
  "tid_lordag":"09.00 - 18.00",
  "rullestol":"1",
  "adresse":"Jacobsfjorden , Bryggen",
  "pris":"10",
  "id":"13",
  "place":"BRYGGEN VISITOR CENTRE",
  "dame":"1",
  "longitude":"5.3222145"
  },
  {
  "herre":"NULL",
  "tid_sondag":"ALL",
  "pissoir_only":"1",
  "stellerom":"NULL",
  "latitude":"60.397359",
  "tid_hverdag":"ALL",
  "plassering":"C. SUNDTSGT",
  "tid_lordag":"ALL",
  "rullestol":"NULL",
  "adresse":"C. Sundts gt",
  "pris":"NULL",
  "id":"14",
  "place":"C . SUNDTSGT",
  "dame":"NULL",
  "longitude":"5.313963"
  },
  {
  "herre":"NULL",
  "tid_sondag":"ALL",
  "pissoir_only":"1",
  "stellerom":"NULL",
  "latitude":"60.397557",
  "tid_hverdag":"ALL",
  "plassering":"NORDNES SKOLE",
  "tid_lordag":"ALL",
  "rullestol":"NULL",
  "adresse":"Nordnesparken 3",
  "pris":"NULL",
  "id":"15",
  "place":"NORDNES SKOLE",
  "dame":"NULL",
  "longitude":"5.307858"
  }
];


var markers = [];

//genererer første visning av alle toalettene
function listeVisning(){
  var tjohei = document.getElementById("smør");
  tjohei.innerHTML = "";
  var i = 0;
  toaletter.forEach(function(toalett) {
  i++;
  tjohei.innerHTML += "<li id='liste'>" + i + " <a id='toalettlenke' onclick='klikkern(" + (i) + ")'>" + toalett.place + "</a></li>";
});
}

//googles initmap, tweaked etter behov
function initMap() {
  var infowindow = new google.maps.InfoWindow();
  var bergen = {lat: 60.392209, lng: 5.324011};
  var map = new google.maps.Map(document.getElementById('googlemap'), {
    zoom: 13,
    center: bergen
  });
  infoWindow = new google.maps.InfoWindow;

  //Under kommer Geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      var icon = {url:"../img/pepe.png",
      scaledSize: new google.maps.Size(60, 60)
      };

      marker = new google.maps.Marker({
            position: pos,
            map: map,
            contentString: contentString,
            icon: icon,
      });
      infoWindow.setPosition(pos);
      infoWindow.setContent('Her står du.');
      infoWindow.open(map);
      map.setCenter(pos);

    }, function() {
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    // Hvis Browser ikke støtter geolokasjon
    handleLocationError(false, infoWindow, map.getCenter());
  }


function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
  infoWindow.open(map);
}
  // Under kommer Markers og infowindow


  for(var i = 0; i < toaletter.length; i++){
      var latLng = new google.maps.LatLng(toaletter[i].latitude, toaletter[i].longitude);
      var contentString = toaletter[i].id + ". " + toaletter[i].place;

      marker = new google.maps.Marker({
            position: latLng,
            label: toaletter[i].id,
            map: map,
            contentString: contentString
      });




      marker.addListener('click', function() {
             infowindow.setContent(this.contentString);
             infowindow.open(map, this);
             map.setCenter(this.getPosition());
       });
           markers.push(marker);
  }
}
// Benytter seg av Markers arrayet for å kunne referere til spesifikke iWindows
function klikkern(i){
  google.maps.event.trigger(markers[i-1], 'click');
}

//Under kommer tekst-søkefunksjon del 1

function searching(){
  var liste = [];
  var tekst = document.getElementById("search");
  var tekstverdi = tekst.value;
  var tjohei = document.getElementById("smør");
  tjohei.innerHTML = "";
  tekstSearch(tekstverdi);

  var kriteriet = /mann|herre|kvinne|dame|gutt|jente|rullestol|hc|handicap|gratis/i;
  var resultat = kriteriet.exec(tekstverdi);

  //det under kan være en smule knodrete. Sjekk etter andre muligheter
  // Tar tekstkriterier og sjekker de i mot regex

  if(resultat != null){
    if(resultat[0] = "mann" || "herre" || "gutt"){
      for(var i = 0; i < toaletter.length; i++){
        if(toaletter[i].herre != "NULL"){
          var tjohei = document.getElementById("smør");
          tjohei.innerHTML += "<li id='liste'>" + (i+1) + " <a id='toalettlenke' onclick='klikkern(" + (i+1) + ")'>" + toaletter[i].place + "</a></li>";
          liste.push(toaletter[i]);
        }
      }
    }
    else if (resultat[0] = "kvinne" || "dame" || "jente" || "pike") {
      for(var i = 0; i < toaletter.length; i++){
        if(toaletter[i].dame != "NULL"){
          var tjohei = document.getElementById("smør");
          tjohei.innerHTML += "<li id='liste'>" + (i+1) + " <a id='toalettlenke' onclick='klikkern(" + (i+1) + ")'>" + toaletter[i].place + "</a></li>";
          liste.push(toaletter[i]);
        }
      }
    }
    else if (resultat[0] = "hc" || "rullestol" || "handicap") {
      for(var i = 0; i < toaletter.length; i++){
        if(toaletter[i].rullestol != "NULL"){
          var tjohei = document.getElementById("smør");
          tjohei.innerHTML += "<li id='liste'>" + (i+1) + " <a id='toalettlenke' onclick='klikkern(" + (i+1) + ")'>" + toaletter[i].place + "</a></li>";
          liste.push(toaletter[i]);
        }
      }
    }
    reduserListe(liste);
  }
  if(tjohei.innerHTML == ""){
    alert("Ingen Treff");
    tjohei.innerHTML = "Du kan tydeligvis ikke søke ordentlig :("
  }
}


// Viser/skjuler avanserte valg for søk
function visAvansert(){
  var innholdet = document.getElementById("toggle");
  if(innholdet.style.display === "none"){
    innholdet.style.display = "flex";
    }
      else {
        innholdet.style.display = "none";
      }
}


//Checker /unchecker alle checkboxes
function toggleCheckbox(element)
 {
   if(!element.checked){
   element.checked;
 } else{
   !element.checked;
 }
 }





 //Klokke Under kopiert fra W3Schools
 function startTime() {
    var today = new Date();
    var h = today.getHours();
    var m = today.getMinutes();
    var s = today.getSeconds();
    m = checkTime(m);
    s = checkTime(s);
    document.getElementById('txt').innerHTML =
    h + ":" + m;
    var t = setTimeout(startTime, 500);
}
function checkTime(i) {
    if (i < 10) {i = "0" + i};
    return i;
}

//  Logger ut og returnerer tiden. Filter for alternativ tidsvisning.
function getTime(){
  var filteret = /(\d\d)(:)(\d\d)(:)(\d\d)?/;
  var tiden = document.getElementById('txt').innerHTML;
  return tiden;
  console.log(tiden);
}

//Finner ukedagstallet og setter verdi av uke/lør/søn. Brukes i tidssøk.
function dagen() {
    var d = new Date();
    var n = d.getDay();
    var x;
    if(n <=5){
      x = "uke";
    }
    else if(n = 6) {
      x = "lør";
    }
    else if(n = 7) {
      x = "søn";
    }
    return x;
}


/*
Sjekker alle checkboxes og filtrerer listen trinnvis.
Benytter seg av tidsFiltrering for tids-søk.
*/
function sjekk(element){
  var listen = toaletter;
  var innholdet = document.getElementById("smør");
  innholdet.innerHTML = "";

  if(document.getElementById('åpen').checked){
    listen = tidsFiltrering()
  }
  if(document.getElementById('gratis').checked){
    listen = listen.filter(toalett => toalett.pris == "NULL")
  }
  if(document.getElementById('mann').checked){
      listen = listen.filter(toalett => toalett.herre != "NULL")
  }
  if(document.getElementById('dame').checked){
    listen = listen.filter(toalett => toalett.dame != "NULL")
  }
  if(document.getElementById('stellerom').checked){
      listen = listen.filter(toalett => toalett.stellerom != "NULL")
  }
  if(document.getElementById('handicap').checked){
      listen = listen.filter(toalett => toalett.rullestol != "NULL")
  }
    for (var i = 0; i < listen.length; i++) {
      innholdet.innerHTML += "<li id='liste'>" + (i+1) + " <a id='toalettlenke' onclick='klikkern(" + (i+1) + ")'>" + toaletter[i].place + "</a></li>";
    }
    reduserListe(listen);
    //Under gjøres det samme som i initmap(), men kunne ikke luke ut enkeltfunksjoner og kalle de,
    //så tok hele dritten.

  }


//reduserListe() kalles av alle søkefunksjoner, og tømmer markerlista for så å fylle den opp med de nye resultatene
function reduserListe(list){
  markers = [];
  var listen = list;
  var infowindow = new google.maps.InfoWindow();
  var bergen = {lat: 60.392209, lng: 5.324011};
  var map = new google.maps.Map(document.getElementById('googlemap'), {
    zoom: 13,
    center: bergen
  });
  infoWindow = new google.maps.InfoWindow;
  for(var i = 0; i < listen.length; i++){
      var latLng = new google.maps.LatLng(listen[i].latitude, listen[i].longitude);
      var contentString = listen[i].id + ". " + listen[i].place;

      marker = new google.maps.Marker({
            position: latLng,
            label: listen[i].id,
            map: map,
            contentString: contentString
      });




      marker.addListener('click', function() {
             infowindow.setContent(this.contentString);
             infowindow.open(map, this);
             map.setCenter(this.getPosition());
       });
           markers.push(marker);
  }
}



// Henter nåtid og returnerer det som en tallvariabel. Brukes av tidsfiltrering().
function tiden(){
  var tidspunkt = Number(getTime().replace(/(\:|\.)/g,""));
  return tidspunkt;
  }

/* Henter ut ukens dag, og basert på resultatet looper igjennom toalettlisten,
og sjekker om verdien for åpningstiden er større enn nåtid. Hvis ja, push til lista[],
som igjen brukes av sjekk()
*/
function tidsFiltrering(){
  var lista = [];
  var x = filterFix();
  var tidspunkt = tiden();
  var toalettet;
  var kriteriet = /(\d\d)\.(\d\d)\s\-\s(\d\d)\.(\d\d)/;
  var toanTest;

  for (var i = 0; i < toaletter.length; i++) {
    if (toaletter[i][x] != "NULL"){// kriterie: åpningstiden er ikke NULL/stengt
      if(toaletter[i][x] == "ALL"){// Kriterie: Åpningstiden er ALL/døgnåpen
        lista.push(toaletter[i]);
      }
      else { //Hvis ikke døgnåpen eller stengt, sjekk siste time+minutt mot nåtid time+minutt
        toalettet = toaletter[i][x];
        toan = kriteriet.exec(toalettet);
        toanTest = Number(toan[3]+toan[4]);
        if(toanTest >= tidspunkt){
          lista.push(toaletter[i]);

        }

      }
      }
    }
    return lista;
  }

//Via dagen() får vi en verdi som gjøres om til en matchende string for variabel-navnene i toaletter[].
// Egentlig overflødig, ettersom dagen() kunne ha hatt det, men skal brukes til andre ting også.
function filterFix(){
  var uke = dagen();
  var listeKriteriet;
      if(uke = "uke"){
        listeKriteriet = "tid_hverdag";
      }
      else if (uke = "lør") {
        listeKriteriet = "tid_lordag";
      }
      else if (uke = "søn") {
        listeKriteriet = "tid_sondag";
      }
  return listeKriteriet;
}

// Her kommer tekstsøk del 2, da på adresse og plassering. Ikke regex
function tekstSearch(){
  var innholdet = document.getElementById("smør");
  var inputen = document.getElementById('search').value;
  var knekken = inputen.toUpperCase();
  var res = knekken.split(" ");
      var liste = [];


  for (var i = 0; i < toaletter.length; i++) {
    //Splitter plassering for treff i søk
      var inspiserer = toaletter[i].plassering.toUpperCase();
      var knekker = inspiserer.split(" ");
      // Splitter adresse for søk på adresse
      var inspisient = toaletter[i].adresse.toUpperCase();
      var knukket = inspisient.split(" ");

      if(res[0] == knekker[0] || res[0] == knekker[1]){
        // innholdet.innerHTML += "<li>" + "toalett " + (i+1) +" ved " + "<a id='toalettlenke' onclick='klikkern(" + (i+1) + ")'>" + toaletter[i].place + "</li>" +("</br>");
        liste.push(toaletter[i]);
      }
      else if (res[0] == knukket[0] || res[0] == knukket[1] || res[0] == knukket[2]) {
        //innholdet.innerHTML += "<li>" + "toalett " + (i+1) +" ved " + "<a id='toalettlenke' onclick='klikkern(" + (i+1) + ")'>" + toaletter[i].place + "</li>" +("</br>");
        liste.push(toaletter[i]);
      }

  }
  for (var i = 0; i < liste.length; i++) {
            innholdet.innerHTML += "<li id='liste'>" + (i+1) + " <a id='toalettlenke' onclick='klikkern(" + (i+1) + ")'>" + toaletter[i].place + "</a></li>";
  }
  reduserListe(liste);
}
